<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Class Manager Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --border: #e2e8f0;
            --green: #10b981;
            --red: #ef4444;
            --orange: #f59e0b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }

        /* HEADER */
        header {
            background: linear-gradient(135deg, #4338ca 0%, #6366f1 100%);
            color: white; padding: 15px; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand h1 { margin: 0; font-size: 1.1rem; }
        
        /* Edit Button in Header */
        .header-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer;
        }
        .header-btn.active { background: #ef4444; border-color: #ef4444; }

        /* CONTROLS */
        .controls { background: var(--surface); padding: 15px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 12px; }
        .row { display: flex; gap: 10px; }
        .grow { flex-grow: 1; }
        
        select, input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; background: #fff; }

        button {
            border: none; border-radius: 8px; padding: 12px; font-weight: 600; font-size: 0.9rem;
            display: flex; justify-content: center; align-items: center; gap: 6px; cursor: pointer;
        }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-red { background: var(--red); color: white; }
        .btn-orange { background: var(--orange); color: white; }
        
        /* TABLE */
        .table-wrap { overflow-x: auto; background: var(--surface); margin-top: 10px; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        
        th, td { padding: 14px 10px; border-bottom: 1px solid var(--border); text-align: center; white-space: nowrap; }
        
        /* Sticky Column */
        th:first-child, td:first-child {
            position: sticky; left: 0; background: var(--surface); z-index: 10;
            border-right: 2px solid #f1f5f9; text-align: left;
            min-width: 140px; max-width: 140px;
        }
        th:first-child { z-index: 20; background: #f8fafc; }
        th { background: #f8fafc; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; }

        input[type="checkbox"] { width: 24px; height: 24px; accent-color: var(--primary); }
        
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; display: inline-block;}
        .paid { background: #dcfce7; color: #166534; }
        .unpaid { background: #fee2e2; color: #991b1b; }

        /* Edit Mode Styles */
        .edit-tool { display: none; }
        body.edit-mode .edit-tool { display: inline-block; }
        body.edit-mode th { background: #fff1f2; } 

        /* FOOTER */
        footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 15px; border-top: 1px solid var(--border);
            z-index: 90; display: flex; gap: 10px;
        }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-box { background: white; width: 90%; max-width: 400px; border-radius: 12px; padding: 20px; }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
    </style>
</head>
<body>

    <header>
        <div class="brand"><h1>Class Manager</h1></div>
        <button class="header-btn" onclick="toggleEditMode()" id="editModeBtn">ðŸ”’ Edit</button>
    </header>

    <div class="controls">
        <div class="row">
            <select id="classSelect" onchange="switchClassView()" class="grow">
                <option value="">Loading...</option>
            </select>
            <button class="btn-green" onclick="openModal('classModal')">+</button>
        </div>

        <div id="mainControls" style="display:none;">
            <div class="row">
                <input type="month" id="monthPicker" onchange="renderTable()" class="grow">
                <button class="btn-green grow" onclick="openModal('studentModal')">Add Student</button>
            </div>
            <div class="row edit-tool" style="margin-top:10px;">
                 <button class="btn-red grow" onclick="openDateModal()">+ Add Date Column</button>
            </div>
        </div>
    </div>

    <div id="tableContainer" class="table-wrap" style="display:none;">
        <table id="mainTable">
            <thead><tr id="tableHead"></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div id="emptyMsg" style="padding:40px; text-align:center; color:#888;">No students found.</div>
    </div>

    <footer id="footerBar" style="display:none;">
        <button class="btn-orange grow" onclick="sendBulkSMS()">ðŸ“¢ Class Over (Notify All)</button>
    </footer>

    <div id="classModal" class="modal">
        <div class="modal-box">
            <h3>New Class</h3>
            <div class="form-group"><input type="text" id="newClassName" placeholder="Name"></div>
            <div class="row"><button class="btn-red grow" onclick="closeModal('classModal')">Cancel</button><button class="btn-blue grow" onclick="createClass()">Create</button></div>
        </div>
    </div>

    <div id="studentModal" class="modal">
        <div class="modal-box">
            <h3>Add Student</h3>
            <input type="hidden" id="editStudentId">
            <div class="form-group"><label>Name</label><input type="text" id="newStudentName"></div>
            <div class="form-group"><label>Phone</label><input type="tel" id="newStudentPhone"></div>
            <div class="form-group"><label>Join Month</label><input type="month" id="newStudentJoinDate"></div>
            <div class="row"><button class="btn-red grow" onclick="closeModal('studentModal')">Cancel</button><button class="btn-blue grow" onclick="saveStudent()">Save</button></div>
        </div>
    </div>

    <div id="dateModal" class="modal">
        <div class="modal-box">
            <h3>Add Date</h3>
            <div class="form-group"><input type="date" id="newDateVal"></div>
            <div class="row"><button class="btn-red grow" onclick="closeModal('dateModal')">Cancel</button><button class="btn-blue grow" onclick="addDate()">Add</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ==========================================
        // PASTE YOUR FIREBASE CONFIG HERE
        // ==========================================
               const firebaseConfig = {
  apiKey: "AIzaSyAH96DvWSPBX5ODO0elz9t3A2y2e8-KRRg",
  authDomain: "nanadahara-c5735.firebaseapp.com",
  databaseURL: "https://nanadahara-c5735-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nanadahara-c5735",
  storageBucket: "nanadahara-c5735.firebasestorage.app",
  messagingSenderId: "646704617972",
  appId: "1:646704617972:web:38ba6dc500c78d70ae01a1",
  measurementId: "G-09WEBN0S5J"
};
        // ==========================================

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dataRef = ref(db, 'teacherApp_Speed_v2');

        let appData = { classes: [], currentId: null };
        let editMode = false;

        onValue(dataRef, (snapshot) => {
            const data = snapshot.val();
            if(data) {
                appData = data;
                if(!appData.classes) appData.classes = [];
                updateDropdown();
                if(appData.currentId) renderTable();
            } else {
                appData = { classes: [], currentId: null };
                save();
            }
        });

        function save() { set(dataRef, appData); }

        window.toggleEditMode = function() {
            editMode = !editMode;
            const btn = document.getElementById('editModeBtn');
            if(editMode) {
                document.body.classList.add('edit-mode');
                btn.innerText = "ðŸ”“ Done";
                btn.classList.add('active');
            } else {
                document.body.classList.remove('edit-mode');
                btn.innerText = "ðŸ”’ Edit";
                btn.classList.remove('active');
            }
            renderTable();
        };

        // --- ATTENDANCE & SMS ---
        
        window.toggleAtt = function(id, date) {
            const s = getStudent(id);
            if(!s.attendance) s.attendance = {};
            
            if(s.attendance[date]) {
                delete s.attendance[date]; // Unmark
            } else {
                s.attendance[date] = true; // Mark Present
                
                // AUTOMATIC ARRIVAL SMS
                if(s.phone) {
                    const clean = s.phone.replace(/[^0-9+]/g, '');
                    // Small timeout to allow the checkbox to check visually before redirecting
                    setTimeout(() => {
                        window.location.href = `sms:${clean}?body=Student ${s.name} has arrived to class.`;
                    }, 100);
                }
            }
            save();
        };

        window.toggleFee = function(id) {
            const m = document.getElementById('monthPicker').value;
            const s = getStudent(id);
            if(!s.fees) s.fees = {};

            if(s.fees[m]) {
                if(editMode && confirm("Remove payment?")) { delete s.fees[m]; save(); }
            } else {
                if(confirm(`Mark ${s.name} PAID?`)) {
                    s.fees[m] = true;
                    save();
                    // RECEIPT SMS
                    if(s.phone) {
                        const clean = s.phone.replace(/[^0-9+]/g, '');
                        setTimeout(() => {
                            window.location.href = `sms:${clean}?body=Payment received for ${s.name} (${m}). Thank you.`;
                        }, 100);
                    }
                }
            }
        };

        window.sendBulkSMS = function() {
            const cls = getClass();
            if(!cls) return;

            // Find session matching current View (approximate "Today")
            // Since users might pick older months, we just look for columns currently visible in the table.
            // But "Class Over" implies TODAY.
            const todayStr = new Date().toISOString().split('T')[0];
            
            // 1. Find session that matches today
            // If user hasn't added today's date column, we can't know who is present today.
            // Let's check if today's date exists in cls.sessions
            const sessionExists = cls.sessions.includes(todayStr);

            if(!sessionExists) {
                alert("Please add TODAY'S date column first, and mark attendance.");
                return;
            }

            // 2. Filter students present TODAY
            const presentStudents = cls.students.filter(s => s.attendance && s.attendance[todayStr]);

            if(presentStudents.length === 0) {
                alert("No students marked present for today (" + todayStr + ")");
                return;
            }

            // 3. Collect Numbers
            let numbers = [];
            presentStudents.forEach(s => {
                if(s.phone) {
                    // Remove non-digits
                    numbers.push(s.phone.replace(/[^0-9]/g, ''));
                }
            });

            if(numbers.length === 0) {
                alert("Students are present, but no phone numbers saved.");
                return;
            }

            // 4. Create Bulk Link
            // iPhone uses '&' or comma. Android uses '?' or comma. 
            // The standard cross-platform way for bulk is comma separated in the `sms:` part.
            const numString = numbers.join(',');
            const msg = "Class is over. Students are leaving now.";
            
            window.location.href = `sms:${numString}?body=${encodeURIComponent(msg)}`;
        };


        // --- CRUD ---
        window.createClass = function() {
            const name = document.getElementById('newClassName').value;
            if(!name) return;
            if(!appData.classes) appData.classes = [];
            const newClass = { id: Date.now(), name, students: [], sessions: [] };
            appData.classes.push(newClass);
            appData.currentId = newClass.id;
            save(); closeModal('classModal');
        };

        window.saveStudent = function() {
            const id = document.getElementById('editStudentId').value;
            const name = document.getElementById('newStudentName').value;
            const phone = document.getElementById('newStudentPhone').value;
            const joined = document.getElementById('newStudentJoinDate').value;
            if(!name) return;

            const cls = getClass();
            if(!cls.students) cls.students = [];

            if(id) {
                const s = cls.students.find(x => x.id == id);
                if(s) { s.name = name; s.phone = phone; s.joinedMonth = joined; }
            } else {
                cls.students.push({ id: Date.now(), name, phone, joinedMonth: joined, attendance: {}, fees: {} });
            }
            save(); closeModal('studentModal');
            document.getElementById('editStudentId').value = "";
            document.getElementById('newStudentName').value = "";
            document.getElementById('newStudentPhone').value = "";
        };

        window.editStudent = function(id) {
            const s = getStudent(id);
            document.getElementById('editStudentId').value = s.id;
            document.getElementById('newStudentName').value = s.name;
            document.getElementById('newStudentPhone').value = s.phone;
            document.getElementById('newStudentJoinDate').value = s.joinedMonth;
            openModal('studentModal');
        };

        window.deleteStudent = function(id) {
            if(confirm("Delete student?")) {
                const cls = getClass();
                cls.students = cls.students.filter(s => s.id !== id);
                save();
            }
        };

        window.addDate = function() {
            const d = document.getElementById('newDateVal').value;
            const cls = getClass();
            if(!cls.sessions) cls.sessions = [];
            if(!cls.sessions.includes(d)) { cls.sessions.push(d); cls.sessions.sort(); save(); }
            closeModal('dateModal');
        };
        
        window.removeDate = function(d) {
             if(confirm("Delete date column?")) {
                 const cls = getClass();
                 cls.sessions = cls.sessions.filter(date => date !== d);
                 save();
             }
        };

        // --- RENDER ---
        window.switchClassView = function() {
            const val = document.getElementById('classSelect').value;
            if(val) {
                appData.currentId = parseInt(val); save(); renderTable();
                document.getElementById('mainControls').style.display = 'block';
                document.getElementById('tableContainer').style.display = 'block';
                document.getElementById('footerBar').style.display = 'flex';
            }
        };

        window.renderTable = function() {
            const cls = getClass();
            if(!cls) return;
            const currentMonth = document.getElementById('monthPicker').value;
            const tbody = document.getElementById('tableBody');
            const thead = document.getElementById('tableHead');
            tbody.innerHTML = ''; thead.innerHTML = '';

            const students = (cls.students || []).filter(s => currentMonth >= s.joinedMonth);
            const sessions = (cls.sessions || []).filter(d => d.startsWith(currentMonth));

            if(students.length === 0) {
                document.getElementById('emptyMsg').style.display = 'block';
                document.getElementById('mainTable').style.display = 'none';
                return;
            }
            document.getElementById('emptyMsg').style.display = 'none';
            document.getElementById('mainTable').style.display = 'table';

            let headHtml = `<th>Student</th><th>Fee</th>`;
            sessions.forEach(d => {
                const delBtn = editMode ? `<div onclick="removeDate('${d}')" style="color:red;font-size:10px;cursor:pointer">DEL</div>` : '';
                headHtml += `<th>${delBtn}${d.split('-')[2]}</th>`;
            });
            if(editMode) headHtml += `<th>Edit</th>`;
            thead.innerHTML = headHtml;

            students.forEach(s => {
                if(!s.fees) s.fees = {};
                if(!s.attendance) s.attendance = {};
                const tr = document.createElement('tr');
                
                const nameHtml = `<div><strong>${s.name}</strong></div><div style="font-size:0.75rem; color:#666">${s.phone||''}</div>`;
                
                const isPaid = s.fees[currentMonth];
                const feeBadge = isPaid 
                    ? `<div class="badge paid" onclick="toggleFee(${s.id})">PAID</div>`
                    : `<div class="badge unpaid" onclick="toggleFee(${s.id})">PAY</div>`;

                let attHtml = '';
                sessions.forEach(date => {
                    const checked = s.attendance[date] ? 'checked' : '';
                    attHtml += `<td><input type="checkbox" ${checked} onchange="toggleAtt(${s.id}, '${date}')"></td>`;
                });

                let editHtml = '';
                if(editMode) {
                    editHtml = `<td>
                        <button class="btn-orange" style="padding:4px;" onclick="editStudent(${s.id})">âœŽ</button>
                        <button class="btn-red" style="padding:4px; margin-top:4px;" onclick="deleteStudent(${s.id})">X</button>
                    </td>`;
                }

                tr.innerHTML = `<td>${nameHtml}</td><td>${feeBadge}</td>${attHtml}${editHtml}`;
                tbody.appendChild(tr);
            });
        };

        function getClass() { return appData.classes.find(c => c.id === appData.currentId); }
        function getStudent(id) { return getClass().students.find(s => s.id === id); }
        function updateDropdown() {
             const sel = document.getElementById('classSelect');
             sel.innerHTML = '<option value="">Select Class</option>';
             if(appData.classes) appData.classes.forEach(c => {
                 const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name;
                 if(c.id == appData.currentId) opt.selected = true;
                 sel.appendChild(opt);
             });
             if(appData.currentId) {
                 document.getElementById('mainControls').style.display = 'block';
                 document.getElementById('tableContainer').style.display = 'block';
                 document.getElementById('footerBar').style.display = 'flex';
                 renderTable();
             }
        }

        window.openModal = (id) => { 
            document.getElementById(id).classList.add('active'); 
            if(id === 'dateModal') document.getElementById('newDateVal').value = new Date().toISOString().split('T')[0];
            if(id === 'studentModal' && !document.getElementById('editStudentId').value) document.getElementById('newStudentJoinDate').value = document.getElementById('monthPicker').value;
        };
        window.closeModal = (id) => {
            document.getElementById(id).classList.remove('active');
            if(id==='studentModal') {
                document.getElementById('editStudentId').value = "";
                document.getElementById('newStudentName').value = "";
                document.getElementById('newStudentPhone').value = "";
            }
        };
        window.openDateModal = () => window.openModal('dateModal');
        window.onload = () => { document.getElementById('monthPicker').value = new Date().toISOString().slice(0, 7); };

    </script>
</body>
</html>
